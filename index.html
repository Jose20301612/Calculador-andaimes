<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Calculador de Andaimes v3.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            padding: 15px;
            padding-bottom: 100px;
        }

        .container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #2c3e50;
            font-size: 24px;
            margin-bottom: 5px;
        }

        .version {
            color: #27ae60;
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .step {
            background: #ecf0f1;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            color: #34495e;
            font-size: 14px;
        }

        .upload-zone {
            background: #e8f5e9;
            padding: 30px 20px;
            border-radius: 8px;
            border: 3px dashed #4caf50;
            text-align: center;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .upload-zone:active {
            background: #c8e6c9;
        }

        input[type="file"] {
            display: none;
        }

        .info {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
            font-size: 14px;
            line-height: 1.6;
        }

        .reference {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #2196f3;
        }

        .canvas-area {
            border: 3px solid #2c3e50;
            border-radius: 8px;
            margin: 20px 0;
            overflow: auto;
            max-height: 400px;
        }

        canvas {
            display: block;
            touch-action: none;
        }

        /* Interface Visual da Casa */
        .house-visual {
            background: white;
            padding: 30px;
            margin: 30px 0;
            border-radius: 12px;
            border: 3px solid #34495e;
        }

        .house-container {
            position: relative;
            max-width: 600px;
            margin: 0 auto;
        }

        .house-diagram {
            width: 100%;
            aspect-ratio: 1.2;
            border: 4px solid #34495e;
            border-radius: 8px;
            position: relative;
            background: #ecf0f1;
        }

        .corner-point {
            position: absolute;
            width: 50px;
            height: 50px;
            background: #3498db;
            border: 4px solid white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 10;
            touch-action: manipulation;
        }

        .corner-point:active {
            transform: scale(0.95);
            background: #2980b9;
        }

        .corner-point.filled {
            background: #27ae60;
        }

        .corner-value {
            position: absolute;
            background: #2c3e50;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
        }

        /* Posições dos cantos - SEQUÊNCIA ANTI-HORÁRIA */
        /* SUL (Porta): 1, 2 */
        .p1 { bottom: -25px; left: 20%; }
        .p2 { bottom: -25px; right: 20%; }
        /* LESTE: 3, 4 */
        .p3 { right: -25px; top: 20%; }
        .p4 { right: -25px; bottom: 20%; }
        /* NORTE: 5, 6 */
        .p5 { top: -25px; left: 20%; }
        .p6 { top: -25px; right: 20%; }
        /* OESTE: 7, 8 */
        .p7 { left: -25px; top: 20%; }
        .p8 { left: -25px; bottom: 20%; }

        /* Valores próximos aos pontos */
        .v1 { bottom: -45px; left: 20%; transform: translateX(-50%); }
        .v2 { bottom: -45px; right: 20%; transform: translateX(50%); }
        .v3 { right: -65px; top: 20%; }
        .v4 { right: -65px; bottom: 20%; }
        .v5 { top: -45px; left: 20%; transform: translateX(-50%); }
        .v6 { top: -45px; right: 20%; transform: translateX(50%); }
        .v7 { left: -65px; top: 20%; }
        .v8 { left: -65px; bottom: 20%; }

        .door-marker {
            position: absolute;
            bottom: -60px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 40px;
        }

        .side-label {
            position: absolute;
            font-weight: 700;
            font-size: 14px;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
        }

        .label-norte { top: -50px; left: 50%; transform: translateX(-50%); background: #3498db; }
        .label-sul { bottom: -80px; left: 50%; transform: translateX(-50%); background: #e74c3c; }
        .label-leste { right: -80px; top: 50%; transform: translateY(-50%); background: #f39c12; }
        .label-oeste { left: -80px; top: 50%; transform: translateY(-50%); background: #9b59b6; }

        /* Linhas de muro */
        .wall-line {
            position: absolute;
            background: #e67e22;
            display: none;
        }

        .wall-line.show {
            display: block;
        }

        .wall-line.top { top: -2px; left: 0; right: 0; height: 8px; }
        .wall-line.bottom { bottom: -2px; left: 0; right: 0; height: 8px; }
        .wall-line.left { left: -2px; top: 0; bottom: 0; width: 8px; }
        .wall-line.right { right: -2px; top: 0; bottom: 0; width: 8px; }

        .wall-label {
            position: absolute;
            background: #e67e22;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
        }

        .wall-label.top { top: 5px; left: 50%; transform: translateX(-50%); }
        .wall-label.bottom { bottom: 5px; left: 50%; transform: translateX(-50%); }
        .wall-label.left { left: 5px; top: 50%; transform: translateY(-50%); }
        .wall-label.right { right: 5px; top: 50%; transform: translateY(-50%); }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 14px;
        }

        input[type="number"], select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #3498db;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .muro-select {
            display: none;
            margin-top: 10px;
        }

        .muro-select.show {
            display: block;
        }

        button {
            background: #3498db;
            color: white;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            touch-action: manipulation;
        }

        button:active {
            background: #2980b9;
            transform: scale(0.98);
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:active {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .hidden {
            display: none !important;
        }

        .msg {
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-weight: 600;
            font-size: 14px;
        }

        .msg-success {
            background: #d4edda;
            color: #155724;
        }

        .msg-error {
            background: #f8d7da;
            color: #721c24;
        }

        .legend {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 13px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
        }

        .legend-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 3px solid white;
        }

        @media (max-width: 600px) {
            .house-visual {
                padding: 20px 10px;
            }
            
            .side-label {
                font-size: 11px;
                padding: 4px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>[ANDAIME] Calculador de Andaimes</h1>
        <div class="version">v3.0 - Interface Visual</div>

        <div class="step" id="stepIndicator">Passo 1: Upload da Planta</div>

        <!-- Passo 1: Upload -->
        <div id="step1">
            <div class="info">
                <strong>[INFO] Novo Sistema Visual:</strong><br>
                1. Carregue a planta e marque a porta<br>
                2. Clique nos 8 cantos da casa<br>
                3. Digite a medida de cada canto<br>
                4. Marque muros se houver<br>
                5. Calcule!<br><br>
                <strong style="color: #e74c3c;">[!] IMPORTANTE:</strong> Se baixou o arquivo, pode não funcionar devido a restrições de segurança do navegador. Para usar corretamente, <strong>hospede no GitHub Pages</strong>!
            </div>

            <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                <h3>Carregar Planta Baixa</h3>
                <p style="color: #666; margin-top: 8px; font-size: 14px;">Toque para selecionar foto</p>
                <input type="file" id="fileInput" accept="image/*">
            </div>

            <div id="msgArea"></div>
        </div>

        <!-- Passo 2: Marcar Porta -->
        <div id="step2" class="hidden">
            <div class="reference">
                <strong>[PONTO] Marque a PORTA da casa</strong><br>
                Isso define: Porta = Sul (南 Minami)
            </div>

            <div class="canvas-area">
                <canvas id="canvas"></canvas>
            </div>
        </div>

        <!-- Passo 3: Interface Visual -->
        <div id="step3" class="hidden">
            <div class="reference">
                <strong>[CASA] Clique nos 8 cantos para definir terrenos</strong><br>
                Azul [O] = Vazio | Verde [V] = Preenchido
            </div>

            <div class="house-visual">
                <div class="house-container">
                    <div class="house-diagram" id="houseDiagram">
                        <!-- Labels dos lados -->
                        <div class="side-label label-norte">北 NORTE</div>
                        <div class="side-label label-sul">南 SUL</div>
                        <div class="side-label label-leste">東 LESTE</div>
                        <div class="side-label label-oeste">西 OESTE</div>

                        <!-- Linhas de muro -->
                        <div class="wall-line top" id="wallNorte">
                            <div class="wall-label top" id="wallNorteLabel"></div>
                        </div>
                        <div class="wall-line bottom" id="wallSul">
                            <div class="wall-label bottom" id="wallSulLabel"></div>
                        </div>
                        <div class="wall-line left" id="wallOeste">
                            <div class="wall-label left" id="wallOesteLabel"></div>
                        </div>
                        <div class="wall-line right" id="wallLeste">
                            <div class="wall-label right" id="wallLesteLabel"></div>
                        </div>

                        <!-- 8 Pontos clicáveis - SEQUÊNCIA ANTI-HORÁRIA -->
                        <!-- SUL (Porta): 1, 2 -->
                        <div class="corner-point p1" onclick="abrirModal(1, 'Sul Esq')">1</div>
                        <div class="corner-point p2" onclick="abrirModal(2, 'Sul Dir')">2</div>
                        <!-- LESTE: 3, 4 -->
                        <div class="corner-point p3" onclick="abrirModal(3, 'Leste Sup')">3</div>
                        <div class="corner-point p4" onclick="abrirModal(4, 'Leste Inf')">4</div>
                        <!-- NORTE: 5, 6 -->
                        <div class="corner-point p5" onclick="abrirModal(5, 'Norte Esq')">5</div>
                        <div class="corner-point p6" onclick="abrirModal(6, 'Norte Dir')">6</div>
                        <!-- OESTE: 7, 8 -->
                        <div class="corner-point p7" onclick="abrirModal(7, 'Oeste Sup')">7</div>
                        <div class="corner-point p8" onclick="abrirModal(8, 'Oeste Inf')">8</div>

                        <!-- Valores -->
                        <div class="corner-value v1" id="value1"></div>
                        <div class="corner-value v2" id="value2"></div>
                        <div class="corner-value v3" id="value3"></div>
                        <div class="corner-value v4" id="value4"></div>
                        <div class="corner-value v5" id="value5"></div>
                        <div class="corner-value v6" id="value6"></div>
                        <div class="corner-value v7" id="value7"></div>
                        <div class="corner-value v8" id="value8"></div>

                        <!-- Porta -->
                        <div class="door-marker">[PORTA]</div>
                    </div>
                </div>

                <div class="legend">
                    <strong>Legenda:</strong>
                    <div class="legend-item">
                        <div class="legend-circle" style="background: #3498db;"></div>
                        <span>Azul = Ponto vazio (clique para preencher)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-circle" style="background: #27ae60;"></div>
                        <span>Verde = Ponto preenchido</span>
                    </div>
                    <div class="legend-item">
                        <div style="width: 30px; height: 8px; background: #e67e22;"></div>
                        <span>Laranja = Muro</span>
                    </div>
                </div>
            </div>

            <!-- Informação sobre medidas -->
            <div id="infoMedidas" class="hidden" style="background:#e3f2fd; padding:15px; border-radius:8px; margin:20px 0; border-left:4px solid #2196f3;">
                <strong>[MEDIDA] Nota:</strong> As medidas da casa são fixas nesta versão (Comp: 9100mm, Larg: 8190mm, Kiso: 150mm).
                <br>Em breve: inputs customizáveis!
            </div>

            <!-- NOVO: Interface de Beirais -->
            <div id="beiraisSection" class="hidden" style="margin-top: 30px;">
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                    <strong>[CASA] Saída do Telhado (Beirais)</strong><br>
                    Clique em cada lado para informar quanto o telhado sai.<br>
                    Se não sai, digite <strong>0</strong> ou deixe em branco.
                </div>

                <div class="house-visual">
                    <div class="house-container">
                        <div class="house-diagram" style="background: #fef5e7; border-color: #f39c12;">
                            <!-- Labels -->
                            <div class="side-label label-norte" style="cursor: pointer; background: #3498db;" onclick="abrirModalBeiral('norte')">
                                北 NORTE<br><small id="beiralNorteLabel">Clique aqui</small>
                            </div>
                            <div class="side-label label-sul" style="cursor: pointer; background: #e74c3c;" onclick="abrirModalBeiral('sul')">
                                南 SUL<br><small id="beiralSulLabel">Clique aqui</small>
                            </div>
                            <div class="side-label label-leste" style="cursor: pointer; background: #f39c12;" onclick="abrirModalBeiral('leste')">
                                東 LESTE<br><small id="beiralLesteLabel">Clique aqui</small>
                            </div>
                            <div class="side-label label-oeste" style="cursor: pointer; background: #9b59b6;" onclick="abrirModalBeiral('oeste')">
                                西 OESTE<br><small id="beiralOesteLabel">Clique aqui</small>
                            </div>

                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 60px; opacity: 0.3;">
                                [CASA]
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Varanda -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 20px;">
                    <h3 style="margin-bottom: 15px;">[PREDIO] Tem Varanda no 2º Andar?</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div>
                            <label>Varanda em qual lado?</label>
                            <select id="varandaLado" onchange="toggleVarandaMedida()">
                                <option value="">Sem varanda</option>
                                <option value="sul">Sul (南)</option>
                                <option value="leste">Leste (東)</option>
                                <option value="norte">Norte (北)</option>
                                <option value="oeste">Oeste (西)</option>
                            </select>
                        </div>
                        <div id="varandaMedidaDiv" style="display: none;">
                            <label>Quanto sai a varanda? (mm)</label>
                            <input type="number" id="varandaMedida" placeholder="Ex: 900">
                        </div>
                    </div>
                </div>
            </div>

            <button class="btn-success" onclick="calcularAndaimes()" id="btnFinalizar" style="display: none;">
                OK CALCULAR ANDAIMES
            </button>
        </div>

        <!-- Modal de Input -->
        <div class="modal" id="modal">
            <div class="modal-content">
                <div class="modal-title" id="modalTitle">Ponto X</div>
                
                <div>
                    <label>Terreno Disponível (mm):</label>
                    <input type="number" id="inputTerreno" placeholder="Ex: 900" inputmode="numeric">
                </div>

                <div id="muroSection" class="hidden">
                    <div class="checkbox-row">
                        <input type="checkbox" id="inputMuro" onchange="toggleMuroModal()">
                        <label style="margin: 0;">Tem muro neste lado?</label>
                    </div>
                    <div class="muro-select" id="muroSelectModal">
                        <label>Largura do muro:</label>
                        <select id="inputMuroLargura">
                            <option value="120">120mm</option>
                            <option value="150">150mm</option>
                            <option value="220">220mm</option>
                        </select>
                    </div>
                </div>

                <div class="btn-grid">
                    <button class="btn-danger" onclick="fecharModal()">X Cancelar</button>
                    <button class="btn-success" onclick="salvarPonto()">OK Salvar</button>
                </div>
            </div>
        </div>

        <!-- Modal de Beiral -->
        <div class="modal" id="modalBeiral">
            <div class="modal-content">
                <div class="modal-title" id="modalBeiralTitle">Beiral - Lado X</div>
                
                <div>
                    <label>Quanto o telhado sai neste lado? (mm)</label>
                    <input type="number" id="inputBeiral" placeholder="Digite 0 se não sai" inputmode="numeric">
                    <p style="font-size: 13px; color: #666; margin-top: 8px;">
                        [DICA] Se não tem beiral, digite <strong>0</strong>
                    </p>
                </div>

                <div class="btn-grid">
                    <button class="btn-danger" onclick="fecharModalBeiral()">X Cancelar</button>
                    <button class="btn-success" onclick="salvarBeiral()">OK Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let img = null;
        let pontoAtual = 0;
        let dados = {
            pontos: {},
            muros: {},
            beirais: {
                sul: null,
                leste: null,
                norte: null,
                oeste: null
            }
        };
        let beiraisCompletos = false;

        // Upload
        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            showMsg('Carregando imagem...', 'info');

            // Verificar tamanho (max 20MB)
            if (file.size > 20 * 1024 * 1024) {
                showMsg('ERRO: Foto muito grande! Use uma foto menor.', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (evt) => {
                const src = evt.target.result;
                img = new Image();
                img.onload = () => {
                    showMsg('Imagem carregada! Agora marque a porta.', 'success');
                    setTimeout(irParaPasso2, 600);
                };
                img.onerror = () => {
                    showMsg('ERRO: Nao foi possivel carregar. Tente outra foto.', 'error');
                };
                img.src = src;
            };
            reader.onerror = () => {
                showMsg('ERRO: Falha ao ler o arquivo. Tente novamente.', 'error');
            };
            reader.readAsDataURL(file);
        });

        function showMsg(texto, tipo) {
            const classe = tipo === 'success' ? 'msg-success' : tipo === 'error' ? 'msg-error' : 'info';
            document.getElementById('msgArea').innerHTML = `<div class="msg ${classe}">${texto}</div>`;
        }

        function irParaPasso2() {
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
            document.getElementById('stepIndicator').textContent = 'Passo 2: Marcar Porta';

            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');

            const maxW = Math.min(700, window.innerWidth - 70);
            const scale = maxW / img.width;
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;

            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            canvas.addEventListener('touchstart', marcarPorta, {passive: false});
            canvas.addEventListener('click', marcarPorta);
        }

        function marcarPorta(e) {
            e.preventDefault();
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();

            let x, y;
            if (e.type === 'touchstart') {
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            } else {
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            }

            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            // Triângulo
            ctx.fillStyle = '#e74c3c';
            ctx.beginPath();
            ctx.moveTo(x, y - 20);
            ctx.lineTo(x - 15, y + 10);
            ctx.lineTo(x + 15, y + 10);
            ctx.closePath();
            ctx.fill();

            ctx.strokeStyle = 'white';
            ctx.lineWidth = 3;
            ctx.stroke();

            canvas.onclick = null;
            setTimeout(irParaPasso3, 800);
        }

        function irParaPasso3() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.remove('hidden');
            document.getElementById('stepIndicator').textContent = 'Passo 3: Definir Terrenos (Clique nos Pontos)';
        }

        function abrirModal(ponto, descricao) {
            pontoAtual = ponto;
            document.getElementById('modalTitle').textContent = `Ponto ${ponto} - ${descricao}`;
            
            // Preencher valores existentes
            if (dados.pontos[ponto]) {
                document.getElementById('inputTerreno').value = dados.pontos[ponto].terreno;
            } else {
                document.getElementById('inputTerreno').value = '';
            }

            // Mostrar opção de muro apenas para pontos do mesmo lado
            const ladosMuro = {
                1: 'sul', 2: 'sul',
                3: 'leste', 4: 'leste',
                5: 'norte', 6: 'norte',
                7: 'oeste', 8: 'oeste'
            };

            const lado = ladosMuro[ponto];
            const primeiroDoLado = (ponto === 1 || ponto === 3 || ponto === 5 || ponto === 7);

            if (primeiroDoLado) {
                document.getElementById('muroSection').classList.remove('hidden');
                if (dados.muros[lado]) {
                    document.getElementById('inputMuro').checked = true;
                    document.getElementById('muroSelectModal').classList.add('show');
                    document.getElementById('inputMuroLargura').value = dados.muros[lado];
                } else {
                    document.getElementById('inputMuro').checked = false;
                    document.getElementById('muroSelectModal').classList.remove('show');
                }
            } else {
                document.getElementById('muroSection').classList.add('hidden');
            }

            document.getElementById('modal').classList.add('show');
            setTimeout(() => document.getElementById('inputTerreno').focus(), 300);
        }

        function toggleMuroModal() {
            const checked = document.getElementById('inputMuro').checked;
            const select = document.getElementById('muroSelectModal');
            if (checked) {
                select.classList.add('show');
            } else {
                select.classList.remove('show');
            }
        }

        function fecharModal() {
            document.getElementById('modal').classList.remove('show');
        }

        function salvarPonto() {
            const terreno = parseInt(document.getElementById('inputTerreno').value);
            
            if (!terreno || terreno <= 0) {
                alert('[!] Digite um valor válido!');
                return;
            }

            // Salvar terreno
            dados.pontos[pontoAtual] = { terreno };

            // Salvar muro se for primeiro do lado
            const ladosMuro = {
                1: 'sul', 2: 'sul',
                3: 'leste', 4: 'leste',
                5: 'norte', 6: 'norte',
                7: 'oeste', 8: 'oeste'
            };

            const lado = ladosMuro[pontoAtual];
            const primeiroDoLado = (pontoAtual === 1 || pontoAtual === 3 || pontoAtual === 5 || pontoAtual === 7);

            if (primeiroDoLado) {
                if (document.getElementById('inputMuro').checked) {
                    dados.muros[lado] = parseInt(document.getElementById('inputMuroLargura').value);
                } else {
                    delete dados.muros[lado];
                }
            }

            atualizarVisual();
            fecharModal();

            // Verificar se todos os 8 pontos foram preenchidos
            if (Object.keys(dados.pontos).length === 8) {
                document.getElementById('infoMedidas').classList.remove('hidden');
                document.getElementById('beiraisSection').classList.remove('hidden');
            }
        }

        function atualizarVisual() {
            // Atualizar cor do ponto
            for (let i = 1; i <= 8; i++) {
                const ponto = document.querySelector(`.p${i}`);
                if (dados.pontos[i]) {
                    ponto.classList.add('filled');
                    document.getElementById(`value${i}`).textContent = dados.pontos[i].terreno + 'mm';
                    document.getElementById(`value${i}`).style.display = 'block';
                }
            }

            // Atualizar muros
            const lados = ['norte', 'sul', 'leste', 'oeste'];
            lados.forEach(lado => {
                const capitalize = lado.charAt(0).toUpperCase() + lado.slice(1);
                const wallEl = document.getElementById(`wall${capitalize}`);
                const labelEl = document.getElementById(`wall${capitalize}Label`);
                
                if (dados.muros[lado]) {
                    wallEl.classList.add('show');
                    labelEl.textContent = `MURO ${dados.muros[lado]}mm`;
                } else {
                    wallEl.classList.remove('show');
                }
            });
        }

        // FUNÇÕES DE BEIRAL
        let ladoBeiralAtual = '';

        function abrirModalBeiral(lado) {
            ladoBeiralAtual = lado;
            const nomes = {sul: '南 Sul', leste: '東 Leste', norte: '北 Norte', oeste: '西 Oeste'};
            document.getElementById('modalBeiralTitle').textContent = 'Beiral - ' + nomes[lado];
            document.getElementById('inputBeiral').value = dados.beirais[lado] !== null ? dados.beirais[lado] : '';
            document.getElementById('modalBeiral').classList.add('show');
            setTimeout(() => document.getElementById('inputBeiral').focus(), 300);
        }

        function salvarBeiral() {
            const valor = document.getElementById('inputBeiral').value;
            const beiral = valor === '' ? 0 : parseInt(valor);
            
            if (beiral < 0) {
                alert('[!] Digite um valor válido (0 ou maior)!');
                return;
            }

            dados.beirais[ladoBeiralAtual] = beiral;
            
            // Atualizar label
            const labelId = 'beiral' + ladoBeiralAtual.charAt(0).toUpperCase() + ladoBeiralAtual.slice(1) + 'Label';
            document.getElementById(labelId).textContent = beiral === 0 ? 'Sem beiral' : beiral + 'mm';
            
            fecharModalBeiral();
            verificarBeiraisCompletos();
        }

        function fecharModalBeiral() {
            document.getElementById('modalBeiral').classList.remove('show');
        }

        function verificarBeiraisCompletos() {
            const completos = Object.values(dados.beirais).every(v => v !== null);
            if (completos) {
                beiraisCompletos = true;
                document.getElementById('btnFinalizar').style.display = 'block';
            }
        }

        function toggleVarandaMedida() {
            const lado = document.getElementById('varandaLado').value;
            const div = document.getElementById('varandaMedidaDiv');
            if (lado) {
                div.style.display = 'block';
            } else {
                div.style.display = 'none';
            }
        }

        function calcularAndaimes() {
            console.log('[GO] Função calcularAndaimes chamada!');
            console.log('[DADOS] Dados atuais:', dados);
            
            try {
                // Verificar se tem todos os 8 pontos
                if (Object.keys(dados.pontos).length !== 8) {
                    alert('[!] Preencha todos os 8 pontos primeiro!');
                    return;
                }
                
                console.log('[OK] Todos os 8 pontos preenchidos');
                
                // Pegar medidas básicas
                const comp = 9100; // Comprimento padrão
                const larg = 8190; // Largura padrão
                const kiso = 150;
                
                console.log('[MEDIDA] Medidas base:', {comp, larg, kiso});
                
                // Função auxiliar de cálculo
                function calcSpan(medida, kiso, t1, t2, muro, beiral, temVaranda) {
                    console.log('[NUM] calcSpan chamado:', {medida, kiso, t1, t2, muro, beiral, temVaranda});
                    
                    let u1 = t1 - 70;
                    let u2 = t2 - 70;
                    if (muro) {
                        u1 += muro;
                        u2 += muro;
                    }
                    
                    let total = medida + kiso + u1 + u2;
                    let n18 = Math.floor(total / 1800);
                    let sobra = total - (n18 * 1800);
                    
                    console.log('[DADOS] Total:', total, 'Spans 1.8:', n18, 'Sobra:', sobra);
                    
                    // Ajustar
                    const pad = [1800,1200,900,600,400,200];
                    let aj1=0, aj2=0;
                    if (!pad.includes(sobra)) {
                        for(let i=10; i<=200; i+=10) {
                            if(pad.includes(sobra-i)){
                                aj1=Math.floor(i/2); aj2=i-aj1;
                                sobra-=i; break;
                            }
                        }
                    }
                    
                    let spans = [];
                    for(let i=0; i<n18; i++) spans.push(1.8);
                    if(sobra>=200) spans.push(sobra/1000);
                    
                    u1-=aj1; u2-=aj2;
                    let esp = Math.max(u1, u2);
                    
                    // Determinar plataforma - LÓGICA CORRIGIDA
                    let plat;
                    
                    // Verificar se precisa WW (beiral > 900mm OU tem varanda)
                    if ((beiral > 900 || temVaranda) && esp >= 780) {
                        plat = 'WW'; // Dupla W
                    }
                    // Sempre preferir W quando couber (>=780mm)
                    else if (esp >= 780 && esp <= 930) {
                        plat = 'W';
                    }
                    else if (esp > 930) {
                        plat = 'W'; // Muito espaço, mas sem beiral grande = usa W mesmo
                    }
                    // S corrigido: 580-700mm
                    else if (esp >= 580 && esp <= 700) {
                        plat = 'S';
                    }
                    else if (esp >= 550 && esp < 580) {
                        plat = 'Sb';
                    }
                    else if (esp >= 450 && esp < 550) {
                        plat = 'M';
                    }
                    else if (esp >= 250 && esp < 450) {
                        plat = 'Centa';
                    }
                    else if (esp < 250) {
                        plat = '[!] INSUFICIENTE (' + esp + 'mm)';
                    }
                    
                    console.log('[PLAT] Plataforma:', plat, '| Espaço:', esp, 'mm | Beiral:', beiral, 'mm | Varanda:', temVaranda);
                    
                    return {n18, spans, t1:u1, t2:u2, plat, tot:medida+kiso+u1+u2};
                }
                
                // Calcular lados
                // Verificar varanda
                const varandaLado = document.getElementById('varandaLado').value;
                const varandaMedida = varandaLado ? parseInt(document.getElementById('varandaMedida').value) || 0 : 0;
                
                console.log('[DIR] Calculando SUL...');
                const sul = calcSpan(comp, kiso, dados.pontos[1].terreno, dados.pontos[2].terreno, dados.muros['sul'] || 0, dados.beirais.sul, varandaLado === 'sul');
                
                console.log('[DIR] Calculando LESTE...');
                const leste = calcSpan(larg, kiso, dados.pontos[3].terreno, dados.pontos[4].terreno, dados.muros['leste'] || 0, dados.beirais.leste, varandaLado === 'leste');
                
                console.log('[DIR] Calculando NORTE...');
                const norte = calcSpan(comp, kiso, dados.pontos[5].terreno, dados.pontos[6].terreno, dados.muros['norte'] || 0, dados.beirais.norte, varandaLado === 'norte');
                
                console.log('[DIR] Calculando OESTE...');
                const oeste = calcSpan(larg, kiso, dados.pontos[7].terreno, dados.pontos[8].terreno, dados.muros['oeste'] || 0, dados.beirais.oeste, varandaLado === 'oeste');
                
                console.log('[OK] Cálculos completos:', {sul, leste, norte, oeste});
                
                // Mostrar
                let html = '<div style="background:white; padding:25px; border-radius:12px; border:3px solid #27ae60; margin-top:30px;">';
                html += '<h2 style="color:#27ae60; margin-bottom:20px;">[OK] Cálculos Concluídos!</h2>';
                
                const lados = [
                    {nome:'SUL',cor:'#e74c3c',data:sul},
                    {nome:'LESTE',cor:'#f39c12',data:leste},
                    {nome:'NORTE',cor:'#3498db',data:norte},
                    {nome:'OESTE',cor:'#9b59b6',data:oeste}
                ];
                
                lados.forEach(l => {
                    html += `<div style="background:#f8f9fa; padding:20px; border-radius:8px; margin:15px 0; border-left:6px solid ${l.cor};">`;
                    html += `<h3 style="color:${l.cor}; margin-bottom:15px;">[DIR] ${l.nome}</h3>`;
                    html += '<div style="font-size:14px; line-height:2;">';
                    html += `<div><strong>Spans 1.8m:</strong> ${l.data.n18}x</div>`;
                    html += `<div><strong>Plataforma:</strong> <span style="background:#27ae60; color:white; padding:4px 12px; border-radius:12px; font-weight:700;">${l.data.plat}</span></div>`;
                    html += `<div><strong>Terrenos:</strong> ${l.data.t1}mm | ${l.data.t2}mm</div>`;
                    html += `<div><strong>Sequência:</strong> ${l.data.spans.map(s=>s.toFixed(1)+'m').join(' + ')}</div>`;
                    html += `<div><strong>Total:</strong> ${l.data.tot}mm</div>`;
                    html += '</div></div>';
                
                // Adicionar legenda
                html += '<div style="background:#ecf0f1; padding:20px; border-radius:8px; margin-top:25px;">';
                html += '<h3 style="color:#2c3e50; margin-bottom:15px;">[INFO] Legenda de Plataformas:</h3>';
                html += '<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:10px; font-size:13px;">';
                html += '<div><strong>W:</strong> 780-930mm (plataforma 400mm, 2 colunas)</div>';
                html += '<div><strong>WW:</strong> Dupla W (quando beiral > 900mm OU varanda)</div>';
                html += '<div><strong>S:</strong> 580-700mm (plataforma 250mm, 2 colunas)</div>';
                html += '<div><strong>Sb:</strong> 550-580mm (bracket normal 340mm)</div>';
                html += '<div><strong>M:</strong> 450-550mm (bracket curto 300mm)</div>';
                html += '<div><strong>Centa:</strong> 250-450mm (1 coluna, plataforma no meio)</div>';
                html += '</div></div>';
                
                html += '</div>';
                
                console.log('[ART] HTML gerado, adicionando ao DOM...');
                
                const div = document.createElement('div');
                div.id = 'resultadoCalculo';
                div.innerHTML = html;
                div.style.display = 'block';
                
                // Remover resultado anterior se existir
                const antigo = document.getElementById('resultadoCalculo');
                if (antigo) antigo.remove();
                
                document.getElementById('step3').appendChild(div);
                div.scrollIntoView({behavior:'smooth'});
                
                console.log('[OK] Resultado mostrado com sucesso!');
                
            } catch (error) {
                console.error('[X] ERRO:', error);
                alert('[X] Erro ao calcular: ' + error.message + '\n\nAbra o console (F12) para mais detalhes.');
            }
        }

        // Enter para salvar
        document.getElementById('inputTerreno').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                salvarPonto();
            }
        });

        // Fechar modal tocando fora
        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') {
                fecharModal();
            }
        });

        // Fechar modal beiral tocando fora (verificar se existe)
        const modalBeiral = document.getElementById('modalBeiral');
        if (modalBeiral) {
            modalBeiral.addEventListener('click', (e) => {
                if (e.target.id === 'modalBeiral') {
                    fecharModalBeiral();
                }
            });
        }

        // Enter para salvar beiral (verificar se existe)
        const inputBeiral = document.getElementById('inputBeiral');
        if (inputBeiral) {
            inputBeiral.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    salvarBeiral();
                }
            });
        }

        console.log('[OK] Script carregado completamente');
    </script>
</body>
</html>
